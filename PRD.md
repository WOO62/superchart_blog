# 슈퍼차트 블로그 상위노출 대시보드 PRD

## 프로젝트 개요
네이버 블로그 상위노출 모니터링 시스템의 대시보드 개발

## 목표
- 실시간 상위노출 현황 모니터링
- 캠페인별 성과 추적
- 매니저별 실적 관리
- 자동화된 데이터 수집 및 분석

## 주요 기능

### 1. 데이터 수집 시스템
- **MySQL 데이터 소스**: 읽기 전용 접근
- **Supabase 실시간 저장소**: 처리된 데이터 저장
- **하이브리드 모니터링**: GitHub Gist + 시간 기반 필터링
- **자동 동기화**: MySQL → Supabase 데이터 동기화

### 2. 대시보드 인터페이스

#### 2.1 통계 카드
- **오늘 등록**: 당일 등록된 리뷰 수
- **이번 달 게재**: 월간 게재 수
- **매니저별 실적**: 
  - 월간 실적 (성공률 포함)
  - 전체 실적 (성공률 포함)

#### 2.2 월별 실적 분석
- **접이식 UI**: 최근 6개월 데이터
- **월별 매니저 성과**: 각 매니저의 월별 게재 수 및 성공률
- **시각적 표현**: 테이블 형식의 깔끔한 UI

#### 2.3 실시간 모니터링 테이블
- **캠페인 정보**: 캠페인명, 매니저, 회사명
- **키워드 관리**: 타겟 키워드 표시
- **검색창 바로가기**: 네이버 블로그 검색 링크
  - 첫 번째 키워드로 자동 검색 URL 생성
  - 새 탭에서 검색 결과 확인 가능
- **성공 여부 추적**: 
  - Pending (대기)
  - Success (성공) 
  - Failure (실패)
  - 드롭다운 선택 즉시 자동 저장
- **순위 정보**: 1차/2차 체크 순위
  - 인라인 편집 가능
  - Enter키 또는 포커스 아웃 시 자동 저장
- **피드백 기능**: 실패 사유 기록
  - 구글 시트 스타일 입력
  - 실시간 저장

### 3. 데이터 처리 파이프라인

#### 3.1 리뷰 모니터링
```javascript
// review_monitor_hybrid.js
- MySQL에서 새 리뷰 조회
- GitHub Gist 처리 목록 관리
- Supabase 저장 (재시도 로직 포함)
- 중복 방지 메커니즘
- 프로세스 순서: Supabase 저장 → 성공 시 Slack 알림
```

#### 3.2 실행 환경
- **로컬**: PM2로 관리 (local_monitor.js - 2분 주기)
- **GitHub Actions**: 5분 주기 자동 실행
- **중복 방지**: GitHub Gist로 처리 상태 공유

#### 3.3 모니터링 프로세스
- **리뷰 모니터링**: review_monitor_hybrid.js
- **구매링크 모니터링**: purchase_link_monitor.js (10분 주기)

## 기술 스택

### Frontend
- **Next.js 14**: App Router 사용
- **React**: 컴포넌트 기반 UI
- **Tailwind CSS**: 스타일링
- **TypeScript**: 타입 안정성

### Backend
- **Node.js**: 서버 환경
- **MySQL2**: 데이터베이스 연결
- **Supabase Client**: 실시간 데이터베이스

### 배포
- **Vercel**: 자동 배포
- **GitHub Actions**: CI/CD

## 데이터베이스 스키마

### Supabase: exposure_tracking
```sql
- id: 자동 증가 ID
- proposition_id: MySQL Propositions.id 참조
- campaign_name: 캠페인명
- manager: 담당 매니저
- company_name: 회사명
- keywords: 타겟 키워드
- post_link: 블로그 포스트 URL
- blogger_id: 블로거 ID
- review_registered_at: 리뷰 등록 시간
- success_status: pending/success/failure
- first_check_rank: 1차 체크 순위
- second_check_rank: 2차 체크 순위
- feedback: 피드백 내용
- created_at: 생성 시간
- updated_at: 수정 시간
```

## 보안 규칙
- **MySQL**: 읽기 전용 접근
- **Supabase**: 서비스 역할 키 사용
- **환경 변수**: .env 파일로 관리
- **데이터 수정**: 사전 승인 필요

## 성과 지표
- **데이터 완전성**: 46% proposition_id 매칭
- **실시간성**: 5분 이내 데이터 반영
- **안정성**: 재시도 로직으로 99% 성공률

## 향후 개선 사항
- [ ] 상위노출 순위 자동 체크
- [ ] 키워드별 성과 분석
- [ ] 경쟁사 분석 기능
- [ ] 알림 시스템 구축
- [ ] 데이터 시각화 강화

## 메인 대시보드 기능

### 매출 통계 카드
- **이번 달 블로그 매출**: 
  - purpose IS NULL인 matching 주문만 집계
  - 전월 대비 변화율 표시
- **올해 블로그 매출**: 
  - 올해 누적 블로그 매출 (purpose IS NULL)
  - 전년 대비 변화율 표시
- **이번 달 슈퍼차트 매출**: 
  - 전체 matching 주문 집계 (purpose 무관)
  - 전월 대비 변화율 표시

### 차트 시각화
- **매출 추이 차트**:
  - 최근 12개월 월별 매출 추이
  - 블로그 매출(빨간색) vs 슈퍼차트 매출(파란색)
  - 실시간 MySQL 데이터 연동
- **발행량 차트**:
  - 최근 12개월 월별 리뷰 발행량
  - exposure_tracking 테이블 기반

### 데이터 소스
- **MySQL Charges 테이블**:
  - 읽기 전용 접근
  - `order` LIKE '%matching%' OR `order` IS NULL 조건
  - createdAt 필드로 날짜 필터링
- **Supabase exposure_tracking**:
  - 발행량 통계용

## 변경 이력

### 2025-08-06
- **매니저별 금액 현황 추가**
  - 매니저별 수락금액/충전금액 카드 구현
  - salt 매니저 최상단 정렬
  - NULL 매니저 "미지정"으로 표시
  - 시각적 비율 바 추가
  - 지난 금액 현황 접기/펼치기 기능
    - 최근 6개월 과거 데이터 표시
    - 월별로 그룹화된 매니저별 통계
    - 느린 로딩을 위한 온디맨드 데이터 페칭
  
- **월별 매니저 충전금액 차트**
  - 매니저별 월별 충전 추이 시각화
  - 0원 데이터 필터링 (차트 및 툴팁)
  - 매니저별 고유 색상 적용
  
- **데이터 정규화**
  - 중복 salt 매니저 통합 (CASE문 활용)
  - NULL order 포함한 정확한 충전금액 계산
  - 데이터베이스 레벨 필터링으로 성능 최적화

- **시간대 처리 버그 수정**
  - MySQL UTC 시간과 Supabase 저장 시간 동기화
  - review_registered_at 미래 시간 표시 문제 해결
  - 웹 대시보드에서 정확한 한국 시간(KST) 표시

- **TypeScript 타입 오류 수정**
  - monthItem any 타입 추가
  - COLORS 객체 index signature 추가
  - 사용하지 않는 heroicons import 제거

### 2025-08-05
- **메인 대시보드 기능 구현**
  - MySQL 실시간 데이터 연동 (읽기 전용)
  - 매출 통계 카드 3종 (블로그, 슈퍼차트)
  - 최근 12개월 매출 추이 차트
  - 발행량 추이 차트
  - TypeScript 타입 안정성 개선

- **대시보드 UI/UX 개선**
  - 성공여부 드롭다운 선택 시 즉시 저장 및 UI 반영
  - 입력 필드 구글 시트 스타일로 단순화
  - 클릭 시 바로 편집, Enter/포커스 아웃 시 자동 저장
  - 실시간 UI 업데이트로 사용성 향상
  - **네이버 검색창 바로가기 추가**
    - 키워드별 블로그 검색 링크 자동 생성
    - 첫 번째 키워드로 검색 URL 구성

- **배포 환경 이슈 해결**
  - API 엔드포인트 통한 업데이트 방식 도입
  - 서버 측 Service Role Key 사용으로 RLS 우회
  - 클라이언트-서버 분리로 보안 강화

- **리뷰 모니터링 안정성 개선**
  - Supabase 저장 실패 시 Gist에 표시하지 않도록 수정
  - `supabaseSaved` 필드로 저장 성공 여부 추적
  - 실패한 리뷰 자동 재처리 로직 구현
  - **프로세스 순서 변경**: Supabase 저장 → Slack 알림 (저장 성공 시에만)
  - **환경변수 초기화 타이밍 개선**: 런타임 시 Supabase 클라이언트 초기화

- **데이터 무결성 강화**
  - 중복 체크 후 insert로 upsert 대체
  - 누락된 리뷰 복구 스크립트 추가
  - GitHub Actions 환경변수 설정 개선
  - MySQL createdAt 컬럼명 이슈 해결

- **코드베이스 정리**
  - 일회성 디버깅 스크립트들을 old_scripts 폴더로 이동
  - 현재 사용 중인 5개 파일만 유지 (review_monitor_hybrid.js, local_monitor.js 등)
  - PM2 프로세스 관리로 안정성 향상

### 2025-08-04
- 통계 카드 기능 추가
- 월별 실적 접이식 UI 구현
- 리뷰 모니터링 재시도 로직 개선
- CSV 임포트 기능 구현
- MySQL-Supabase 데이터 동기화 구현
- proposition_id 매칭 로직 추가

### 2025-08-03
- 초기 대시보드 구현
- 실시간 모니터링 테이블 구축
- GitHub Gist 연동 구현

## 매니저별 금액 현황 기능

### 매니저별 금액 카드
- **수락금액**: Propositions 테이블에서 status IN (2, 10, 12, 20, 22, 24, 30, 32, 40)인 데이터의 point 합계
- **충전금액**: Charges 테이블에서 (order LIKE '%matching%' OR order IS NULL) AND purpose IS NULL인 데이터의 amount 합계
- **정렬 순서**: salt 최우선, 그 다음 총 금액순, 미지정은 마지막
- **시각적 표현**: 수락금액(파란색)/충전금액(초록색) 비율 바

### 월별 매니저 충전금액 차트
- **데이터 소스**: 최근 12개월 매니저별 충전금액
- **매니저 정규화**:
  - NULL 또는 빈 문자열 → "미지정"
  - salt 변형들 → "salt"
- **0원 필터링**: 
  - 차트에 0원 매니저 미표시
  - 툴팁에서도 0원 데이터 제외
- **색상 구분**: 매니저별 고유 색상 (salt-빨강, yuzu-파랑, kelly-초록 등)

## 문서 정보
- **작성일**: 2025-08-04
- **최종 수정**: 2025-08-06
- **버전**: 1.5.1